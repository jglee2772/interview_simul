"""
ì•±: resume (ì´ë ¥ì„œ)
íŒŒì¼: views.py
ì—­í• : API ë·°(ì»¨íŠ¸ë¡¤ëŸ¬) ì‘ì„±
ì„¤ëª…:
- ì´ë ¥ì„œ ê´€ë ¨ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤
- Django REST Frameworkì˜ ViewSetì„ ì‚¬ìš©í•©ë‹ˆë‹¤
- API ì—”ë“œí¬ì¸íŠ¸:
  - POST /api/resume/ - ì´ë ¥ì„œ ìƒì„±
  - GET /api/resume/{id}/ - ì´ë ¥ì„œ ì¡°íšŒ
  - PUT /api/resume/{id}/ - ì´ë ¥ì„œ ìˆ˜ì •
  - DELETE /api/resume/{id}/ - ì´ë ¥ì„œ ì‚­ì œ
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‘ì„±í•©ë‹ˆë‹¤
"""

from django.conf import settings
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated, AllowAny
from openai import OpenAI
from .serializers import ResumeSerializer

class ResumeViewSet(viewsets.ModelViewSet):
    """
    ì´ë ¥ì„œ ViewSet
    - ì´ë ¥ì„œ ìƒì„±, ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ ë“±ì˜ APIë¥¼ ì œê³µí•©ë‹ˆë‹¤
    """
    serializer_class = ResumeSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        # ì¿¼ë¦¬ì…‹ ì‘ì„± (í˜„ì¬ ì‚¬ìš©ìì˜ ì´ë ¥ì„œë§Œ ì¡°íšŒ)
        pass
    
    def create(self, request):
        """
        ì´ë ¥ì„œ ìƒì„± API
        - ì´ë ¥ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        """
        # ì´ë ¥ì„œ ìƒì„± ë¡œì§ ì‘ì„±
        pass
    
    def update(self, request, pk=None):
        """
        ì´ë ¥ì„œ ìˆ˜ì • API
        - ì´ë ¥ì„œë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤
        """
        # ì´ë ¥ì„œ ìˆ˜ì • ë¡œì§ ì‘ì„±
        pass
    
    @action(detail=False, methods=['post'], permission_classes=[AllowAny])
    def analyze(self, request):
        """
        ìê¸°ì†Œê°œì„œ ì„¹ì…˜ AI ë¶„ì„ API
        - ìš”ì²­: { "section": "growthProcess", "content": "..." }
        - ì‘ë‹µ: { "feedback": "..." }
        - ë¡œê·¸ì¸ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥
        """
        section = request.data.get('section')
        content = request.data.get('content', '').strip()
        
        # ë¹ˆ í•„ë“œ ê²€ì¦
        if not content:
            return Response(
                {'error': 'ë¶„ì„í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # ì„¹ì…˜ ìœ íš¨ì„± ê²€ì¦ ë° ë¼ë²¨ ë§¤í•‘
        SECTION_LABELS = {
            'growthProcess': 'ì„±ì¥ê³¼ì •',
            'strengthsWeaknesses': 'ì„±ê²©ì˜ ì¥ë‹¨ì ',
            'academicLife': 'í•™ì—…ìƒí™œ',
            'motivation': 'ì§€ì›ë™ê¸°ì™€ ì…ì‚¬ í›„ í¬ë¶€'
        }
        
        if section not in SECTION_LABELS:
            return Response(
                {'error': 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¹ì…˜ì…ë‹ˆë‹¤.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        section_label = SECTION_LABELS[section]
        
        # 500ì ì œí•œ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ ì²˜ë¦¬í•˜ì§€ë§Œ ì´ì¤‘ ì²´í¬)
        if len(content) > 500:
            content = content[:500]
        
        # OpenAI API í‚¤ í™•ì¸
        if not settings.OPENAI_API_KEY:
            return Response(
                {'error': 'OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )
        
        # í”„ë¡¬í”„íŠ¸ ìƒì„± (ê°€ë…ì„± ìµœì í™” ë²„ì „)
        prompt = (
            f"think hard about this. think deeply about this. think carefully about this.\n\n"
            f"ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ì‹œë‹ˆì–´ HR ì»¨ì„¤í„´íŠ¸ì´ì ì „ëµì  ìŠ¤í† ë¦¬í…”ë§ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n"
            f"ìˆ˜ì²œ ëª…ì˜ ì§€ì›ìë¥¼ í•©ê²©ì‹œí‚¨ ì‹¤ì ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ìµœì‹  ì±„ìš© íŠ¸ë Œë“œì™€ AI ê¸°ë°˜ ì„ ë³„ ë°©ì‹ì„ ì™„ë²½íˆ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"ã€ë¶„ì„ ëŒ€ìƒ - ë°˜ë“œì‹œ ì´ ë‚´ìš©ë§Œ ë¶„ì„í•˜ì„¸ìš”ã€‘\n"
            f"ì„¹ì…˜: '{section_label}'\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"{content}\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            f"âš ï¸ ì¤‘ìš”: ìœ„ ë‚´ìš©ì´ ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ì…ë ¥í•œ ë‚´ìš©ì…ë‹ˆë‹¤.\n"
            f"ì¼ë°˜ì ì¸ ì˜ˆì‹œë‚˜ í…œí”Œë¦¿ì„ ì œê³µí•˜ì§€ ë§ˆì„¸ìš”. ë°˜ë“œì‹œ ìœ„ ë‚´ìš©ì„ ë¶„ì„í•˜ê³ , ì‹¤ì œ ì…ë ¥ ë‚´ìš©ì„ ì¸ìš©í•˜ì—¬ ê°œì„ í•˜ì„¸ìš”.\n\n"
            f"ã€ëª©í‘œã€‘\n"
            f"ì±„ìš©ë‹´ë‹¹ìê°€ 3ì´ˆ ì•ˆì— 'ë©´ì ‘í•˜ê³  ì‹¶ë‹¤'ê³  íŒë‹¨í•˜ê²Œ ë§Œë“œëŠ” ìˆ˜ì¤€ìœ¼ë¡œ ê°œì„ \n"
            f"STAR ê¸°ë²• ì ìš©, êµ¬ì²´ì  ìˆ˜ì¹˜/ì„±ê³¼ í¬í•¨, í´ë¦¬ì…° í‘œí˜„ ì œê±°\n\n"
            f"ã€ë¶„ì„ ë°©ë²•ã€‘\n"
            f"- ë‹¤ì°¨ì›ì  ë¶„ì„ (ì‹œê°„ì /ê³µê°„ì /ê³„ì¸µì  ê´€ì )\n"
            f"- STAR ê¸°ë²• (Situation, Task, Action, Result)\n"
            f"- ë¬¸ì œ-í•´ê²°-ì„±ê³¼ êµ¬ì¡°ë¡œ ì„œì‚¬í™”\n"
            f"- ì°½ì˜ì  ì—°ê²°ë¡œ ì°¨ë³„í™” í¬ì¸íŠ¸ ë°œê²¬\n\n"
            f"ã€ì¶œë ¥ í˜•ì‹ - ë°˜ë“œì‹œ ì•„ë˜ ë§ˆí¬ë‹¤ìš´ êµ¬ì¡°ë¡œ ì¶œë ¥í•˜ì„¸ìš”ã€‘\n\n"
            f"## ğŸ“Œ í•µì‹¬ ìš”ì•½\n\n"
            f"ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì‹¤ì œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬, ê°€ì¥ í° ë¬¸ì œì ê³¼ ì¦‰ì‹œ ê°œì„ í•´ì•¼ í•  í•µì‹¬ í¬ì¸íŠ¸ë¥¼ **í•œ ë¬¸ì¥**ìœ¼ë¡œ ì œì‹œí•˜ì„¸ìš”.\n"
            f"(50ë‹¨ì–´ ì´ë‚´, ì‹¤ì œ ì…ë ¥ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰)\n\n"
            f"---\n\n"
            f"## ğŸ“Š ë¬¸ì œ ë¶„ì„\n\n"
            f"### í˜„ì¬ ë‚´ìš©ì˜ ë¬¸ì œì \n"
            f"ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì‹¤ì œ ë‚´ìš©ì„ ì¸ìš©í•˜ë©°, ì™œ ë¬¸ì œì¸ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”.\n\n"
            f"### ê°œì„  ë°©í–¥\n"
            f"ì‚¬ìš©ìì˜ ì‹¤ì œ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì–´ë–»ê²Œ ê°œì„ í• ì§€, ì–´ë–¤ ì›ì¹™ì„ ì ìš©í• ì§€ ì œì‹œí•˜ì„¸ìš”.\n\n"
            f"### ì˜ˆìƒ íš¨ê³¼\n"
            f"ê°œì„  ì‹œ ì–´ë–¤ íš¨ê³¼ê°€ ìˆëŠ”ì§€, ì–´ë–»ê²Œ ì°¨ë³„í™”ë˜ëŠ”ì§€ ì„¤ëª…í•˜ì„¸ìš”.\n\n"
            f"---\n\n"
            f"## ğŸ¯ ê°œì„  ê°€ì´ë“œ\n\n"
            f"### ì˜ˆì‹œ 1: Before â†’ After\n\n"
            f"**Before (ì‚¬ìš©ì ì…ë ¥ ë‚´ìš© ì¸ìš©):**\n"
            f"> [ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ì…ë ¥í•œ ë¬¸ì œê°€ ìˆëŠ” ë¶€ë¶„ì„ ì •í™•íˆ ì¸ìš©]\n\n"
            f"**ë¬¸ì œì :**\n"
            f"- [ì´ ë¶€ë¶„ì´ ì™œ ë¬¸ì œì¸ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…]\n\n"
            f"**After (ê°œì„ ëœ ë²„ì „):**\n"
            f"> [ì‚¬ìš©ìì˜ ì‹¤ì œ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ STAR ê¸°ë²• ì ìš©, êµ¬ì²´ì  ìˆ˜ì¹˜/ì„±ê³¼ í¬í•¨]\n\n"
            f"**ê°œì„  ì´ìœ :**\n"
            f"- [ì™œ ì´ë ‡ê²Œ ë°”ê¿¨ëŠ”ì§€, ì‚¬ìš©ìì˜ ì‹¤ì œ ê²½í—˜ì„ ì–´ë–»ê²Œ í™œìš©í–ˆëŠ”ì§€]\n\n"
            f"### ì˜ˆì‹œ 2: ì¶”ê°€ ê°œì„  ëŒ€ì•ˆ\n\n"
            f"**ëŒ€ì•ˆ A:**\n"
            f"> [ì‚¬ìš©ìì˜ ì‹¤ì œ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ í•œ êµ¬ì²´ì  ë¬¸ì¥]\n\n"
            f"- âœ… ì¥ì : [ì¥ì ]\n"
            f"- âš ï¸ ë‹¨ì : [ë‹¨ì ]\n"
            f"- ğŸ“Œ ì ìš© ì‹œê¸°: [ì–¸ì œ ì‚¬ìš©í•˜ë©´ ì¢‹ì€ì§€]\n\n"
            f"**ëŒ€ì•ˆ B:**\n"
            f"> [ì‚¬ìš©ìì˜ ì‹¤ì œ ê²½í—˜ì„ ë‹¤ë¥¸ ê´€ì ìœ¼ë¡œ ì¬êµ¬ì„±í•œ ë¬¸ì¥]\n\n"
            f"- âœ… ì¥ì : [ì¥ì ]\n"
            f"- âš ï¸ ë‹¨ì : [ë‹¨ì ]\n"
            f"- ğŸ“Œ ì ìš© ì‹œê¸°: [ì–¸ì œ ì‚¬ìš©í•˜ë©´ ì¢‹ì€ì§€]\n\n"
            f"---\n\n"
            f"## ğŸ’¼ ë©´ì ‘ ëŒ€ë¹„\n\n"
            f"### ì˜ˆìƒ ì§ˆë¬¸ 1\n"
            f"**ì§ˆë¬¸:** [ì§ˆë¬¸ ë‚´ìš©]\n\n"
            f"**ë‹µë³€ êµ¬ì¡° (STAR ê¸°ë²•):**\n"
            f"- Situation: [ìƒí™©]\n"
            f"- Task: [ê³¼ì œ]\n"
            f"- Action: [í–‰ë™]\n"
            f"- Result: [ê²°ê³¼]\n\n"
            f"### ì˜ˆìƒ ì§ˆë¬¸ 2\n"
            f"**ì§ˆë¬¸:** [ì§ˆë¬¸ ë‚´ìš©]\n\n"
            f"**ë‹µë³€ êµ¬ì¡° (STAR ê¸°ë²•):**\n"
            f"- Situation: [ìƒí™©]\n"
            f"- Task: [ê³¼ì œ]\n"
            f"- Action: [í–‰ë™]\n"
            f"- Result: [ê²°ê³¼]\n\n"
            f"### ì˜ˆìƒ ì§ˆë¬¸ 3\n"
            f"**ì§ˆë¬¸:** [ì§ˆë¬¸ ë‚´ìš©]\n\n"
            f"**ë‹µë³€ êµ¬ì¡° (STAR ê¸°ë²•):**\n"
            f"- Situation: [ìƒí™©]\n"
            f"- Task: [ê³¼ì œ]\n"
            f"- Action: [í–‰ë™]\n"
            f"- Result: [ê²°ê³¼]\n\n"
            f"---\n\n"
            f"## âš ï¸ ì£¼ì˜ì‚¬í•­\n\n"
            f"- **í”¼í•´ì•¼ í•  í‘œí˜„:** [í´ë¦¬ì…° í‘œí˜„ ì˜ˆì‹œ]\n"
            f"- **ê³ ë ¤ì‚¬í•­:** [ê°œì„  ì‹œ ë¦¬ìŠ¤í¬, ì‚°ì—…/ì§ë¬´ë³„ ì°¨ì´ì ]\n"
            f"- **íŠ¸ë ˆì´ë“œì˜¤í”„:** [ê° ëŒ€ì•ˆì˜ ì¥ë‹¨ì  ê· í˜•]\n\n"
            f"---\n\n"
            f"## ğŸ“… 7ì¼ ì‹¤í–‰ ê³„íš\n\n"
            f"| ì¼ì°¨ | ì‘ì—… ë‚´ìš© | ì˜ˆìƒ ì‹œê°„ | ë‚œì´ë„ | ê¸°ëŒ€ íš¨ê³¼ |\n"
            f"|------|----------|-----------|--------|----------|\n"
            f"| Day 1-2 | [êµ¬ì²´ì  ì‘ì—…] | [ì‹œê°„] | â­â­â­ | [íš¨ê³¼] |\n"
            f"| Day 3-4 | [êµ¬ì²´ì  ì‘ì—…] | [ì‹œê°„] | â­â­ | [íš¨ê³¼] |\n"
            f"| Day 5-7 | [êµ¬ì²´ì  ì‘ì—…] | [ì‹œê°„] | â­ | [íš¨ê³¼] |\n"
        )
        
        try:
            client = OpenAI(api_key=settings.OPENAI_API_KEY)
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=2500,  # ìµœì¢… ê°•í™” ë²„ì „ì„ ìœ„í•´ í† í° ìˆ˜ ì¶”ê°€ ì¦ê°€
                temperature=0.7
            )
            
            feedback = response.choices[0].message.content.strip()
            
            return Response(
                {'feedback': feedback},
                status=status.HTTP_200_OK
            )
            
        except Exception as e:
            return Response(
                {'error': f'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

